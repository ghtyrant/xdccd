<!doctype html>
<html lang="us">
<head>
  <meta charset="utf-8">
  <title>XDCC Downloader</title>
  <link href="jquery-ui.css" rel="stylesheet">
  <script src="external/jquery/jquery.js"></script>
  <script src="jquery-ui.js"></script>
  <script src="external/template/jqueryTemplate.js"></script>
  <style>
  body{
    font: 62.5% "Trebuchet MS", sans-serif;
    margin: 50px;
  }
  .Headers {
    margin-top: 2em;
  }
  #dialog-link {
    padding: .4em 1em .4em 20px;
    text-decoration: none;
    position: relative;
  }
  #dialog-link span.ui-icon {
    margin: 0 5px 0 0;
    position: absolute;
    left: .2em;
    top: 50%;
    margin-top: -8px;
  }
  #icons {
    margin: 0;
    padding: 0;
  }
  #icons li {
    margin: 2px;
    position: relative;
    padding: 4px 0;
    cursor: pointer;
    float: left;
    list-style: none;
  }
  #icons span.ui-icon {
    float: left;
    margin: 0 4px;
  }
  .fakewindowcontain .ui-widget-overlay {
    position: absolute;
  }
  select {
    width: 200px;
  }
  </style>
</head>
<body>
<h2 class="Headers">Bots</h2>
<div id="tabs">
  <ul>
    <li><a href="#newbot">+</a></li>
  </ul>
  <div id="newbot">
    <form id="launchForm" action="">
      Server: <input name="server">
      Nick: <input name="nickname">
      Channels: <input name="channels">
      <button id="launchButton" type="submit">Launch</button>
    </form>
  </div>
</div>
<h2 class="Headers">Search</h2>
<div id="searchInput">
  <form>
    <input id="search">
    <button id="searchButton" type="submit">Search</button>
  </form>
</div>
<div id="searchResult" style="margin-top: 15px">
</div>

<script type="text/javascript">
$( "#tabs" ).tabs();
var tabs = $( "#tabs" ).tabs();
var ul = tabs.find( "ul" );
tabs.tabs( "refresh" );

var availableServers = [
  "irc.alphairc.com",
  "irc.abandoned-irc.net",
  "irc.abjects.net",
  "irc.criten.net",
  "irc.Priv8.jp",
  "irc.rizon.no",
  "irc.1andallirc.net",
  "irc.frozyn.net",
  "irc.mircphantom.net",
  "est.relaxedirc.net",
  "irc.Xerologic.net",
  "irc.zombiesec.net",
  "irc.ztvland.net"
];

$( "#server" ).autocomplete({
  source: availableServers
});

function updateProgressbars(dls)
{
  for(var key in dls)
  {
    for(var dl in dls[key].downloads)
    {  
      $("#progressbar"+dls[key].downloads[dl].dlid).progressbar({
        value: dls[key].downloads[dl].transfered
      });
    }
  }
}

function updateDialogs(res)
{
  for(var key in res)
  {
     $( "#dialog-info-content"+res[key].id ).dialog({
          autoOpen: false,
          width: 400,
          buttons: [
            {
              text: "Ok",
              click: function() {
                $( this ).dialog( "close" );
              }
            },
            {
              text: "Cancel",
              click: function() {
                $( this ).dialog( "close" );
              }
            }
          ]
        });

        // Link to open the dialog
        $( "#dialog-info"+res[key].id ).click(function( event ) {
          $( "#dialog-info-content"+res[key].id ).dialog( "open" );
          event.preventDefault();
        });
      $( "#dialog-info"+res[key].id ).hover(
        function() {
          $( this ).addClass( "ui-state-hover" );
        },
        function() {
          $( this ).removeClass( "ui-state-hover" );
        }
      );
  }
}

$( "#searchButton" ).button();
$( "#launchForm" ).submit(function() {
  var data = $('#launchForm').serializeArray().reduce(function(m, o){ m[o.name] = o.value; return m;}, {});
  data["channels"] = data["channels"].split(",");
  console.log(data); 
  $.ajax( { 
    url: "http://localhost:1984/connect",
    type: "POST",
    data: JSON.stringify(data), 
    contentType: "application/json",
    dataType: 'json',
    success: function(){},
    crossDomain: true
  }); 

  return false;
});
</script>

<script id="botTemplate" type="text/x-jQuery-tmpl">
        <div id="bot${id}">
            <div>Server: ${serverName}</div><div>Channels: {{each channels}} ${$value} {{/each}}</div>
            <div><button onClick="disconnect(${id})">Disconnect</button></div>
            {{if downloads }}
              {{each downloads}}
              <div><b>File:</b> ${$value.filename} <b>Size:</b> ${$value.filesize}</div>
              <div id="progressbar${dlid}"></div>
              {{/each}}
            {{/if downloads}}
        </div>
</script>

<script id="botTemplateTab" type="text/x-jQuery-tmpl">
  <li><a href="#bot${id}">${botname}</a></li>
</script>

<script id="searchResultTemplate" type="text/x-jQuery-tmpl">
  <div>
    <div style="float:left; margin: 0 auto;">
      File: ${filename} Size: ${filesize} 
      </div>
      <div style="float:left; margin: 0 auto; margin-left: 1em;">
        <a href="#" id="dialog-info${id}" class="ui-state-default ui-corner-all"><span class="ui-icon ui-icon-info"></span>more</a>
      </div>
      <div style="float:left; margin: 0 auto;">
      <a href="#" id="dialog-link${id}" class="ui-state-default ui-corner-all"><span class="ui-icon ui-icon-circle-plus"></span>add</a>
      </div>
    </div>
  </div>
<div id="dialog-info-content${id}" title="Details: ${filename}">
  <div>Network: ${network} Channel: ${channel}</div>
  <div>Provider: ${provider} Packagenumber: ${pkgnumber}</div>
</div>
</script>

<script type="text/javascript">
        /*var bots = [
            { id:"1", botname:"foo", serverName: "abjects", channels: ["#x", "#y"], downloads:[{dlid:1, filename:"test.tar.gz", filesize:"234MB", transfered:30 }, {dlid:2, filename:"test.tar.gz", filesize:"234MB", transfered:40 }]},
            { id:"2", botname:"LeecherGod", serverName: "irc.alphairc.com", channels: ["#dude"], downloads:[{dlid:3, filename:"test.tar.gz", filesize:"234MB", transfered:10 }] },
            { id:"3", botname:"SoftKing", serverName: "irc.abandoned-irc.net", channels: ["#xdcc"] },
        ];
        var results = [
          {id: 1, filename: "foobar", filesize:"1.4G", network:"foobar", channel:"#adsf", provider:"mephisto", pkgnumber:"123"},
          {id: 2, filename: "barfoo", filesize:"1G", network:"foobar", channel:"#adsf", provider:"mephisto", pkgnumber:"123"},
        ];
        $("#botTemplateTab").tmpl(bots).appendTo(ul);
        $("#botTemplate").tmpl(bots).appendTo(tabs);
        $("#searchResultTemplate").tmpl(results).appendTo("#searchResult");
        tabs.tabs( "refresh" );
        updateProgressbars(bots);
        updateDialogs(results);*/
        $(document).ready(function() {
                $.ajax({ url: "http://localhost:1984/status"}).then(
                    function(data) {
                      $("#botTemplateTab").tmpl(data).appendTo(ul);
                      $("#botTemplate").tmpl(data).appendTo(tabs);
                      tabs.tabs( "refresh" );
                      updateProgressbars(data);
                    });
        });

        function disconnect(id)
        {
          $.ajax({ url: "http://localhost:1984/disconnect/" + id }).then(function(data){ alert("disconnected!"); });
        }
</script>
</body>
</html>
